<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="T√¨m khu√¥n m·∫∑t c·ªßa b·∫°n trong video YouTube">
    <title>YouTube Face Finder - T√¨m khu√¥n m·∫∑t trong video</title>
    
    <!-- React -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .animate-fade-in-up {
            animation: fadeInUp 0.5s ease-out forwards;
            opacity: 0;
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        .animate-spin {
            animation: spin 1s linear infinite;
        }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useRef, useEffect } = React;

        // Simple icon components
        const LoaderIcon = () => (
            <svg className="animate-spin" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M21 12a9 9 0 1 1-6.219-8.56" />
            </svg>
        );

        const AlertIcon = () => (
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <circle cx="12" cy="12" r="10" />
                <line x1="12" y1="8" x2="12" y2="12" />
                <line x1="12" y1="16" x2="12.01" y2="16" />
            </svg>
        );

        const CheckIcon = () => (
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14" />
                <polyline points="22 4 12 14.01 9 11.01" />
            </svg>
        );

        const UploadIcon = () => (
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                <polyline points="17 8 12 3 7 8" />
                <line x1="12" y1="3" x2="12" y2="15" />
            </svg>
        );

        const CameraIcon = () => (
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z" />
                <circle cx="12" cy="13" r="4" />
            </svg>
        );

        const SearchIcon = () => (
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <circle cx="11" cy="11" r="8" />
                <path d="m21 21-4.35-4.35" />
            </svg>
        );

        const GiftIcon = () => (
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <polyline points="20 12 20 22 4 22 4 12" />
                <rect x="2" y="7" width="20" height="5" />
                <line x1="12" y1="22" x2="12" y2="7" />
                <path d="M12 7H7.5a2.5 2.5 0 0 1 0-5C11 2 12 7 12 7z" />
                <path d="M12 7h4.5a2.5 2.5 0 0 0 0-5C13 2 12 7 12 7z" />
            </svg>
        );

        function FaceFinder() {
            const [step, setStep] = useState('upload');
            const [userPhoto, setUserPhoto] = useState(null);
            const [videoFrames, setVideoFrames] = useState([]);
            const [matchedFrames, setMatchedFrames] = useState([]);
            const [isProcessing, setIsProcessing] = useState(false);
            const [useCamera, setUseCamera] = useState(false);
            const [faceApiReady, setFaceApiReady] = useState(false);
            const [loadingMessage, setLoadingMessage] = useState('');
            const [progress, setProgress] = useState(0);
            const videoRef = useRef(null);
            const canvasRef = useRef(null);
            const fileInputRef = useRef(null);

            useEffect(() => {
                const loadFaceApi = async () => {
                    try {
                        setLoadingMessage('ƒêang t·∫£i AI nh·∫≠n di·ªán khu√¥n m·∫∑t...');
                        
                        await new Promise((resolve) => {
                            const script = document.createElement('script');
                            script.src = 'https://cdn.jsdelivr.net/npm/@vladmandic/face-api/dist/face-api.min.js';
                            script.onload = resolve;
                            document.head.appendChild(script);
                        });
                        
                        setLoadingMessage('ƒêang t·∫£i m√¥ h√¨nh AI...');
                        const MODEL_URL = 'https://cdn.jsdelivr.net/npm/@vladmandic/face-api/model';
                        
                        await Promise.all([
                            faceApi.nets.ssdMobilenetv1.loadFromUri(MODEL_URL),
                            faceApi.nets.faceLandmark68Net.loadFromUri(MODEL_URL),
                            faceApi.nets.faceRecognitionNet.loadFromUri(MODEL_URL)
                        ]);
                        
                        setFaceApiReady(true);
                        setLoadingMessage('');
                        
                        await loadFramesData();
                    } catch (err) {
                        console.error('Error loading face-api:', err);
                        setLoadingMessage('L·ªói t·∫£i th∆∞ vi·ªán. Vui l√≤ng refresh trang.');
                    }
                };
                
                loadFaceApi();
            }, []);

            const loadFramesData = async () => {
                try {
                    const response = await fetch('./frames.json');
                    if (response.ok) {
                        const data = await response.json();
                        
                        const framesWithDescriptors = data.frames.map(frame => ({
                            ...frame,
                            faceDescriptor: new Float32Array(frame.faceDescriptor)
                        }));
                        
                        setVideoFrames(framesWithDescriptors);
                        console.log(`Loaded ${framesWithDescriptors.length} frames`);
                    } else {
                        console.log('No frames.json found');
                    }
                } catch (err) {
                    console.error('Error loading frames:', err);
                }
            };

            useEffect(() => {
                if (useCamera && videoRef.current) {
                    navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' } })
                        .then(stream => {
                            videoRef.current.srcObject = stream;
                        })
                        .catch(err => {
                            console.error('Camera error:', err);
                            alert('Kh√¥ng th·ªÉ truy c·∫≠p camera!');
                            setUseCamera(false);
                        });
                }
                return () => {
                    if (videoRef.current?.srcObject) {
                        videoRef.current.srcObject.getTracks().forEach(track => track.stop());
                    }
                };
            }, [useCamera]);

            const captureFromCamera = async () => {
                const canvas = canvasRef.current;
                const video = videoRef.current;
                
                if (!video.videoWidth) {
                    alert('Camera ch∆∞a s·∫µn s√†ng!');
                    return;
                }
                
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                canvas.getContext('2d').drawImage(video, 0, 0);
                const photoUrl = canvas.toDataURL('image/jpeg', 0.95);
                
                setUserPhoto(photoUrl);
                setUseCamera(false);
                
                if (video.srcObject) {
                    video.srcObject.getTracks().forEach(track => track.stop());
                }
            };

            const handleFileUpload = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => setUserPhoto(e.target.result);
                    reader.readAsDataURL(file);
                }
            };

            const searchForFaces = async () => {
                if (!faceApiReady) {
                    alert('AI ch∆∞a s·∫µn s√†ng!');
                    return;
                }
                
                if (videoFrames.length === 0) {
                    alert('Ch∆∞a c√≥ d·ªØ li·ªáu video! Vui l√≤ng ch·∫°y Python script ƒë·ªÉ t·∫°o frames.json');
                    return;
                }
                
                setIsProcessing(true);
                setStep('results');
                setLoadingMessage('ƒêang ph√¢n t√≠ch khu√¥n m·∫∑t...');
                setProgress(0);
                
                try {
                    const img = await faceApi.bufferToImage(userPhoto);
                    const userDetection = await faceApi
                        .detectSingleFace(img)
                        .withFaceLandmarks()
                        .withFaceDescriptor();
                    
                    if (!userDetection) {
                        alert('Kh√¥ng t√¨m th·∫•y khu√¥n m·∫∑t trong ·∫£nh!');
                        setIsProcessing(false);
                        setStep('upload');
                        setLoadingMessage('');
                        return;
                    }
                    
                    setLoadingMessage('ƒêang so s√°nh v·ªõi video...');
                    
                    const matches = [];
                    const threshold = 0.55;
                    
                    for (let i = 0; i < videoFrames.length; i++) {
                        const frame = videoFrames[i];
                        
                        try {
                            const distance = faceApi.euclideanDistance(
                                userDetection.descriptor,
                                frame.faceDescriptor
                            );
                            
                            if (distance < threshold) {
                                matches.push({
                                    ...frame,
                                    similarity: Math.round((1 - distance) * 100),
                                    distance: distance.toFixed(3)
                                });
                            }
                        } catch (err) {
                            console.error('Error comparing frame:', err);
                        }
                        
                        const percent = Math.round(((i + 1) / videoFrames.length) * 100);
                        setProgress(percent);
                        setLoadingMessage(`ƒêang ki·ªÉm tra: ${percent}%`);
                        
                        await new Promise(r => setTimeout(r, 10));
                    }
                    
                    matches.sort((a, b) => b.similarity - a.similarity);
                    
                    setMatchedFrames(matches);
                    setIsProcessing(false);
                    setLoadingMessage('');
                    setProgress(0);
                } catch (err) {
                    console.error('Error:', err);
                    alert('L·ªói khi t√¨m ki·∫øm!');
                    setIsProcessing(false);
                    setLoadingMessage('');
                }
            };

            return (
                <div className="min-h-screen bg-gradient-to-br from-purple-600 via-pink-500 to-red-500 p-4">
                    <div className="max-w-4xl mx-auto">
                        <div className="bg-white rounded-3xl shadow-2xl p-8 mb-6">
                            <h1 className="text-4xl font-bold text-center mb-2 bg-gradient-to-r from-purple-600 to-pink-600 bg-clip-text text-transparent">
                                üé¨ YouTube Face Finder
                            </h1>
                            <p className="text-center text-gray-600">T√¨m khu√¥n m·∫∑t c·ªßa b·∫°n trong video</p>
                            
                            {!faceApiReady && (
                                <div className="mt-4 flex items-center justify-center gap-2 text-blue-600">
                                    <LoaderIcon />
                                    <span>{loadingMessage || 'ƒêang kh·ªüi ƒë·ªông...'}</span>
                                </div>
                            )}
                            
                            {faceApiReady && videoFrames.length === 0 && (
                                <div className="mt-4 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                                    <div className="flex items-start gap-2">
                                        <AlertIcon />
                                        <div className="text-sm text-yellow-800">
                                            <p className="font-semibold">Ch∆∞a c√≥ d·ªØ li·ªáu video!</p>
                                            <p>Vui l√≤ng ch·∫°y Python script ƒë·ªÉ t·∫°o frames.json</p>
                                        </div>
                                    </div>
                                </div>
                            )}
                            
                            {faceApiReady && videoFrames.length > 0 && (
                                <div className="mt-4 p-4 bg-green-50 border border-green-200 rounded-lg">
                                    <div className="flex items-center gap-2">
                                        <CheckIcon />
                                        <span className="text-sm text-green-800 font-semibold">
                                            ƒê√£ t·∫£i {videoFrames.length} frames t·ª´ video
                                        </span>
                                    </div>
                                </div>
                            )}
                        </div>
                        
                        <div className="bg-white rounded-3xl shadow-2xl p-8">
                            {step === 'upload' && (
                                <div className="space-y-6">
                                    <h2 className="text-2xl font-semibold text-center">T·∫£i ·∫£nh khu√¥n m·∫∑t c·ªßa b·∫°n</h2>
                                    
                                    {!userPhoto ? (
                                        <div className="space-y-4">
                                            {useCamera ? (
                                                <div className="space-y-4">
                                                    <video 
                                                        ref={videoRef}
                                                        autoPlay
                                                        playsInline
                                                        className="w-full max-w-md mx-auto rounded-lg shadow-lg"
                                                    />
                                                    <canvas ref={canvasRef} className="hidden" />
                                                    <div className="flex gap-4 justify-center">
                                                        <button
                                                            onClick={captureFromCamera}
                                                            className="px-6 py-3 bg-green-500 text-white rounded-lg hover:bg-green-600 transition font-semibold"
                                                        >
                                                            üì∏ Ch·ª•p ·∫£nh
                                                        </button>
                                                        <button
                                                            onClick={() => {
                                                                setUseCamera(false);
                                                                if (videoRef.current?.srcObject) {
                                                                    videoRef.current.srcObject.getTracks().forEach(t => t.stop());
                                                                }
                                                            }}
                                                            className="px-6 py-3 bg-gray-400 text-white rounded-lg hover:bg-gray-500 transition"
                                                        >
                                                            H·ªßy
                                                        </button>
                                                    </div>
                                                </div>
                                            ) : (
                                                <div className="flex flex-col sm:flex-row gap-4 justify-center">
                                                    <button
                                                        onClick={() => fileInputRef.current?.click()}
                                                        className="flex items-center justify-center gap-2 px-6 py-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition font-semibold"
                                                    >
                                                        <UploadIcon />
                                                        T·∫£i ·∫£nh l√™n
                                                    </button>
                                                    <button
                                                        onClick={() => setUseCamera(true)}
                                                        className="flex items-center justify-center gap-2 px-6 py-3 bg-purple-500 text-white rounded-lg hover:bg-purple-600 transition font-semibold"
                                                    >
                                                        <CameraIcon />
                                                        D√πng Camera
                                                    </button>
                                                </div>
                                            )}
                                            <input
                                                ref={fileInputRef}
                                                type="file"
                                                accept="image/*"
                                                onChange={handleFileUpload}
                                                className="hidden"
                                            />
                                        </div>
                                    ) : (
                                        <div className="space-y-4">
                                            <img
                                                src={userPhoto}
                                                alt="Your face"
                                                className="max-w-md mx-auto rounded-lg shadow-lg"
                                            />
                                            <div className="flex gap-4 justify-center flex-wrap">
                                                <button
                                                    onClick={searchForFaces}
                                                    disabled={!faceApiReady || videoFrames.length === 0}
                                                    className="flex items-center gap-2 px-8 py-3 bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-lg hover:from-purple-600 hover:to-pink-600 transition transform hover:scale-105 font-semibold disabled:opacity-50 disabled:cursor-not-allowed"
                                                >
                                                    <SearchIcon />
                                                    T√¨m ki·∫øm ngay
                                                </button>
                                                <button
                                                    onClick={() => setUserPhoto(null)}
                                                    className="px-6 py-3 bg-gray-400 text-white rounded-lg hover:bg-gray-500 transition"
                                                >
                                                    Ch·ªçn l·∫°i
                                                </button>
                                            </div>
                                        </div>
                                    )}
                                </div>
                            )}
                            
                            {step === 'results' && (
                                isProcessing ? (
                                    <div className="text-center py-12">
                                        <div className="inline-block">
                                            <svg className="animate-spin h-16 w-16 text-purple-500" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                                                <path d="M21 12a9 9 0 1 1-6.219-8.56" />
                                            </svg>
                                        </div>
                                        <p className="mt-4 text-xl text-gray-600">{loadingMessage}</p>
                                        {progress > 0 && (
                                            <div className="mt-4 max-w-md mx-auto">
                                                <div className="w-full bg-gray-200 rounded-full h-4">
                                                    <div
                                                        className="bg-gradient-to-r from-purple-500 to-pink-500 h-4 rounded-full transition-all"
                                                        style={{ width: `${progress}%` }}
                                                    />
                                                </div>
                                                <p className="mt-2 text-sm text-gray-600">{progress}%</p>
                                            </div>
                                        )}
                                    </div>
                                ) : matchedFrames.length > 0 ? (
                                    <div>
                                        <h2 className="text-2xl font-semibold mb-4 text-center">
                                            üéâ T√¨m th·∫•y {matchedFrames.length} k·∫øt qu·∫£!
                                        </h2>
                                        <div className="grid grid-cols-1 sm:grid-cols-2 gap-6 mb-6">
                                            {matchedFrames.map((frame, idx) => (
                                                <div
                                                    key={frame.id}
                                                    className="relative rounded-lg overflow-hidden shadow-lg hover:shadow-2xl transition group animate-fade-in-up"
                                                    style={{ animationDelay: `${idx * 0.1}s` }}
                                                >
                                                    <img
                                                        src={frame.url}
                                                        alt={`Frame ${frame.id}`}
                                                        className="w-full"
                                                    />
                                                    <div className="absolute bottom-0 left-0 right-0 p-4 text-white bg-gradient-to-t from-black/70">
                                                        <p className="font-semibold">‚è±Ô∏è {frame.timestamp}</p>
                                                        <p className="text-sm">üéØ ƒê·ªô kh·ªõp: {frame.similarity}%</p>
                                                    </div>
                                                    <div className="absolute top-2 right-2 bg-green-500 text-white px-3 py-1 rounded-full text-sm font-semibold">
                                                        #{idx + 1}
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                        <div className="text-center space-y-4">
                                            <button
                                                onClick={() => setStep('donate')}
                                                className="inline-flex items-center gap-2 px-8 py-4 bg-gradient-to-r from-yellow-400 to-orange-500 text-white rounded-lg hover:from-yellow-500 hover:to-orange-600 transition transform hover:scale-105 text-xl font-semibold shadow-lg"
                                            >
                                                <GiftIcon />
                                                ·ª¶ng h·ªô d·ª± √°n
                                            </button>
                                            <br />
                                            <button
                                                onClick={() => {
                                                    setStep('upload');
                                                    setUserPhoto(null);
                                                    setMatchedFrames([]);
                                                }}
                                                className="px-6 py-3 bg-gray-400 text-white rounded-lg hover:bg-gray-500 transition"
                                            >
                                                T√¨m ki·∫øm m·ªõi
                                            </button>
                                        </div>
                                    </div>
                                ) : (
                                    <div className="text-center py-12">
                                        <p className="text-3xl mb-2">üò¢</p>
                                        <p className="text-2xl text-gray-600 mb-4">Kh√¥ng t√¨m th·∫•y khu√¥n m·∫∑t c·ªßa b·∫°n</p>
                                        <p className="text-gray-500 mb-6">Th·ª≠ v·ªõi ·∫£nh kh√°c ho·∫∑c ƒëi·ªÅu ch·ªânh g√≥c ch·ª•p</p>
                                        <button
                                            onClick={() => {
                                                setStep('upload');
                                                setUserPhoto(null);
                                            }}
                                            className="px-6 py-3 bg-purple-500 text-white rounded-lg hover:bg-purple-600 transition"
                                        >
                                            Th·ª≠ l·∫°i
                                        </button>
                                    </div>
                                )
                            )}
                            
                            {step === 'donate' && (
                                <div className="text-center space-y-6">
                                    <h2 className="text-3xl font-bold bg-gradient-to-r from-yellow-400 to-orange-500 bg-clip-text text-transparent">
                                        üíù C·∫£m ∆°n b·∫°n!
                                    </h2>
                                    <p className="text-gray-600">N·∫øu b·∫°n th·∫•y h·ªØu √≠ch, h√£y ·ªßng h·ªô ƒë·ªÉ duy tr√¨ d·ª± √°n</p>
                                    <div className="bg-gradient-to-br from-yellow-100 to-orange-100 p-8 rounded-2xl inline-block">
                                        <div className="bg-white p-6 rounded-xl shadow-xl">
                                            <svg width="200" height="200" viewBox="0 0 200 200">
                                                <rect width="200" height="200" fill="white" />
                                                <rect x="20" y="20" width="20" height="20" fill="black" />
                                                <rect x="60" y="20" width="20" height="20" fill="black" />
                                                <rect x="100" y="20" width="20" height="20" fill="black" />
                                                <rect x="140" y="20" width="20" height="20" fill="black" />
                                                <rect x="160" y="20" width="20" height="20" fill="black" />
                                                <text x="100" y="105" textAnchor="middle" fontSize="14" fill="#666">DONATE</text>
                                            </svg>
                                        </div>
                                        <p className="mt-4 text-gray-700 font-medium">Qu√©t m√£ QR ƒë·ªÉ donate</p>
                                    </div>
                                    <button
                                        onClick={() => {
                                            setStep('upload');
                                            setUserPhoto(null);
                                            setMatchedFrames([]);
                                        }}
                                        className="px-8 py-3 bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-lg hover:from-purple-600 hover:to-pink-600 transition"
                                    >
                                        T√¨m ki·∫øm m·ªõi
                                    </button>
                                </div>
                            )}
                        </div>
                        
                        <div className="mt-6 bg-white/90 rounded-2xl p-6 text-sm text-gray-700">
                            <h3 className="font-semibold text-lg mb-3">üìã H∆∞·ªõng d·∫´n s·ª≠ d·ª•ng:</h3>
                            <ol className="space-y-2 list-decimal list-inside">
                                <li>Ch·∫°y Python script ƒë·ªÉ t·∫£i video YouTube v√† t√°ch frames</li>
                                <li>Upload file frames.json v√†o th∆∞ m·ª•c web app</li>
                                <li>T·∫£i ·∫£nh khu√¥n m·∫∑t ho·∫∑c ch·ª•p t·ª´ camera</li>
                                <li>Nh·∫•n "T√¨m ki·∫øm" v√† ƒë·ª£i k·∫øt qu·∫£</li>
                            </ol>
                            <p className="mt-3 text-xs text-gray-500">
                                ‚úÖ 100% mi·ªÖn ph√≠ ‚Ä¢ üîí X·ª≠ l√Ω tr√™n tr√¨nh duy·ªát ‚Ä¢ üöÄ Kh√¥ng c·∫ßn server
                            </p>
                        </div>
                    </div>
                </div>
            );
        }

        // Render app
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<FaceFinder />);
    </script>
</body>
</html>
